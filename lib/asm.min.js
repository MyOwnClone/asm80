(function(a,b){if(typeof module!="undefined"){module.exports=b();}else{if(typeof define=="function"&&typeof define.amd=="object"){define(b);}else{this[a]=b();
}}}("ASM",function(){var b=null;var f=null;var x={};var C=false;var m=function(G){return G.map(function(I){var H=I.line;H=H.replace("&lt;","<");H=H.replace("&gt;",">");
while(H[H.length-1]==" "){H=H.substr(0,H.length-1);}I.line=H;if(H[0]!=" "){return I;}while(H[0]==" "){H=H.substr(1);}I.line=" "+H;return I;});};var g=function(G){return G.filter(function(I){var H=I.line;
while(H[0]==" "){H=H.substr(1);}return H.length?true:false;});};var q=function(G){return G.map(function(I){var H=I.line;var J={addr:0,line:";;;EMPTYLINE",numline:I.numline};
while(H[0]==" "){H=H.substr(1);}return H.length?I:J;});};var r=function(G){return m(g(G.split(/\n/)));};var A=function(H){var G=1;return H.map(function(I){return{line:I,numline:G++,addr:null,bytes:0};
});};var z=function(G){return G.replace(/^\s+|\s+$/g,"");};var v=function(O,I,S,X){var N=O.line;var L=N.match(/^\s*(\@{0,1}[a-zA-Z0-9-_]+):\s*(.*)/);if(L){O.label=L[1].toUpperCase();
N=L[2];}var K=N.match(/^\s*(\=)\s*(.*)/);if(K){O.opcode=K[1].toUpperCase();N=K[2];}else{K=N.match(/^\s*([\.a-zA-Z0-9-_]+)\s*(.*)/);if(K){O.opcode=K[1].toUpperCase();
N=K[2];}}if(N){while(N.match(/"(.*?);(.*?)"/g)){N=N.replace(/"(.*?);(.*?)"/g,'"$1§$2"');}var T=N.match(/^\s*([^;]*)(.*)/);if(T&&T[1].length){O.paramstring=T[1];
var Y=T[1];while(Y.match(/"(.*?),(.*?)"/g)){Y=Y.replace(/"(.*?),(.*?)"/g,'"$1€$2"');}var R=Y.match(/([0-9]+)\s*DUP\s*\((.*)\)/i);if(R){var V=parseInt(R[1]);
var H="";for(var U=0;U<V;U++){H+=R[2]+",";}Y=H.substring(0,H.length-1);}var P=Y.split(/\s*,\s*/);O.params=P.map(function(Z){return z(Z.replace(/€/g,",").replace(/§/g,";"));
});N=T[2].replace(/§/g,";");}}if(N){var J=N.match(/^\s*;*(.*)/);if(J){O.remark=J[1];if(!O.remark){O.remark=" ";}N="";}}O.notparsed=N;if(O.opcode==="ORG"){O.opcode=".ORG";
}if(O.opcode===".ERROR"){throw {msg:O.paramstring,s:O};}if(O.opcode===".EQU"){O.opcode="EQU";}if(O.opcode===".ORG"){try{return O;}catch(W){throw {msg:W.message,s:O};
}}if(O.opcode==="DEFB"){O.opcode="DB";return O;}if(O.opcode===".DB"){O.opcode="DB";return O;}if(O.opcode===".DW"){O.opcode="DW";return O;}if(O.opcode==="DEFW"){O.opcode="DW";
return O;}if(O.opcode==="DEFS"){O.opcode="DS";return O;}if(O.opcode==="DEFM"){O.opcode="DS";return O;}if(O.opcode==="EQU"||O.opcode==="="||O.opcode==="IF"||O.opcode==="IFN"||O.opcode==="ENDIF"||O.opcode===".INCLUDE"||O.opcode===".MACRO"||O.opcode===".ENDM"||O.opcode===".BLOCK"||O.opcode===".ENDBLOCK"||O.opcode===".REPT"||O.opcode===".CPU"||O.opcode===".ENT"||O.opcode===".ENGINE"||O.opcode==="END"||O.opcode===".END"||O.opcode==="BSZ"||O.opcode==="FCB"||O.opcode==="FCC"||O.opcode==="FDB"||O.opcode==="FILL"||O.opcode==="RMB"||O.opcode==="ZMB"||O.opcode===".PHASE"||O.opcode===".DEPHASE"||O.opcode==="DB"||O.opcode==="DS"||O.opcode==="DW"){return O;
}if(!O.opcode&&O.label){return O;}try{var M=b.parseOpcode(O);}catch(W){throw {msg:W,s:O};}if(M!==null){return M;}if(I[O.opcode]){O.macro=O.opcode;return O;
}if(!O.label&&!S){var G={line:O.line,numline:O.numline,addr:null,bytes:0};if(O.remark&&!O.opcode){return O;}if(!O.params){throw {msg:"Unrecognized instruction "+O.opcode,s:O};
}if(!O.opcode){throw {msg:"Unrecognized instruction "+O.opcode,s:O};}G.line=O.opcode+": "+O.params.join();var Q=v(G,I,true,O);if(!Q.opcode){throw {msg:"Unrecognized instruction "+O.opcode,s:O};
}return(Q);}if(S){throw {msg:"Unrecognized instruction "+X.opcode,s:O};}throw {msg:"Unrecognized instruction "+O.opcode,s:O};};var u=function(I){var N,O,P=null,S,ac=null;
var L={};var G=null;var M=null;var Z=[];var R=0;for(var X=0,U=I.length;X<U;X++){N=I[X].line;O=N.match(/\s*(\.[^\s]+)(.*)/);if(!O){if(G){L[G].push(I[X]);
continue;}else{Z.push(I[X]);}continue;}var Y=O[1].toUpperCase();var W=O[2].match(/^\s*([^;]*)(.*)/);if(W&&W[1].length){P=W[1];S=W[1].split(/\s*,\s*/);ac=S.map(z);
}else{ac=null;}if(Y===".INCLUDE"){if(!ac[0]){throw {msg:"No file name given at line "+N.numline,s:N};}if(x[ac[0]]){throw {msg:"File "+ac[0]+" is already included elsewhere - maybe recursion at line "+N.numline,s:N};
}var K=f(ac[0]);var J=A(K.split(/\n/));J=g(J);J=m(J);var H=u(J);for(var T=0;T<H[0].length;T++){H[0][T].includedFile=ac[0];Z.push(H[0][T]);}for(T in H[1]){L[T]=H[1][T];
}x[ac[0]]=K;continue;}if(Y===".ENDM"){if(!G){throw {msg:"ENDM without MACRO at line "+I[X].numline,s:I[X]};}if(M){Z.push({numline:I[X].numline,line:";rept unroll",addr:null,bytes:0,remark:"REPT unroll"});
for(var Q=0;Q<M;Q++){for(var aa=0;aa<L[G].length;aa++){var ab=L[G][aa].line;Z.push({numline:I[Q].numline,line:ab,addr:null,bytes:0});}}}G=null;M=null;continue;
}if(Y===".MACRO"){if(!ac[0]){throw {msg:"Bad macro name at line "+I[X].numline,s:I[X]};}G=ac[0].toUpperCase();if(L[G]){throw {msg:"Macro redefinition at line "+I[X].numline,s:I[X]};
}L[G]=[];continue;}if(Y===".REPT"){if(!ac[0]){throw {msg:"No repeat count given",s:I[X]};}M=Parser.evaluate(ac[0]);if(!M){throw {msg:"Bad repeat count given",s:I[X]};
}G="*REPT"+I[X].numline;if(L[G]){throw {msg:"Macro redefinition at line "+I[X].numline,s:I[X]};}L[G]=[];continue;}Z.push(I[X]);}if(G){throw {msg:"MACRO "+G+" has no appropriate ENDM",s:I[X]};
}return[Z,L];};var n=function(J,I){var G={line:J.line,addr:J.addr,macro:J.macro,numline:J.numline};for(var H=0;H<I.length;H++){G.line=G.line.replace("%%"+(H+1),I[H]);
}return G;};var d=function(H,L){var J=[];for(var K=0;K<H.length;K++){var M=H[K];if(!M.macro){J.push(M);continue;}var G=L[M.macro];for(var I=0;I<G.length;
I++){var N=v(n(G[I],M.params),L);if(M.label){N.label=M.label;}M.label="";N.remark=M.remark;N.macro=M.macro;M.macro=null;M.remark="";J.push(N);}}return J;
};var w=function(H,I){b=I;if(I.endian){C=I.endian;}x={};var G=A(H.split(/\n/));G=g(G);G=m(G);var J=u(G);G=J[0].map(function(K){return v(K,J[1]);});G=d(G,J[1]);
return G;};var s=function(I,L){b=L;var H=A(I.split(/\n/));H=q(H);H=g(H);H=m(H);var M=u(H);H=H.map(function(O){return v(O,M[1]);});var G="";var N,J;for(var K=0;
K<H.length;K++){N=H[K];J="";if(N.remark=="EMPTYLINE"){G+="\n";continue;}if(N.label){J+=N.label;if(N.opcode!="EQU"&&N.opcode!="="){J+=":";}J+=" ";}while(J.length<10){J+=" ";
}if(N.opcode){J+=N.opcode+" ";}while(J.length<18){J+=" ";}if(N.params){J+=N.params+" ";}if(N.remark){J+=";"+N.remark;}G+=J+"\n";}return G;};var l=function(I){var Z=0;
var R={};var L=null;var S,T;var O=0;var N;var ab=[];var J=0;for(var X=0,W=I.length;X<W;X++){L=I[X];L.pass=1;L.addr=Z;R._PC=Z;if(J!==0){L.phase=J;}if(L.opcode==="ENDIF"){O=0;
continue;}if(O){continue;}if(L.opcode==="IF"){try{N=Parser.evaluate(L.params[0],R);if(!N){O=1;}}catch(aa){O=1;}continue;}if(L.opcode==="IFN"){try{N=Parser.evaluate(L.params[0],R);
if(N){O=1;}}catch(aa){}continue;}if(L.opcode===".BLOCK"){ab.push(L.numline);var U=ab.join("/");R["__"+U]=[];continue;}if(L.opcode===".ENDBLOCK"){var ac=R["__"+ab.join("/")];
for(var H=0;H<ac.length;H++){R[ac[H]]=R[ab.join("/")+"/"+ac[H]];R[ab.join("/")+"/"+ac[H]]=null;}ab.pop();R.__blocks=JSON.stringify(ab);continue;}if(L.label){var G=L.label;
var P=false;if(G[0]==="@"){P=true;G=G.substr(1);L.label=G;}if(ab.length>0){G=ab.join("/")+"/"+G;R["__"+ab.join("/")].push(L.label);}if(R[G+"$"]||(P&&R[L.label]!==undefined)){throw {msg:"Redefine label "+L.label+" at line "+L.numline,s:L};
}if(R[L.label]){R[G]=R[L.label];}else{if(P){R[G]=Z;}}R[G+"$"]=Z;R[L.label]=Z;}try{if(L.opcode===".ORG"){Z=Parser.evaluate(L.params[0],R);L.addr=Z;continue;
}if(L.opcode===".PHASE"){var Y=Parser.evaluate(L.params[0],R);L.addr=Z;J=Y-Z;Z=Y;continue;}if(L.opcode===".DEPHASE"){L.addr=Z;Z=Z-J;J=0;continue;}if(L.opcode==="EQU"){try{R[L.label]=Parser.evaluate(L.params[0],R);
}catch(aa){R[L.label]=null;}continue;}if(L.opcode==="="){R[L.label]=Parser.evaluate(L.params[0],R);continue;}}catch(aa){throw {msg:aa.message,s:L};}if(L.opcode==="DB"||L.opcode==="FCB"){L.bytes=0;
for(T=0;T<L.params.length;T++){try{S=Parser.evaluate(L.params[T],R);if(typeof(S)==="number"){L.bytes++;continue;}if(typeof(S)==="string"){L.bytes+=S.length;
continue;}}catch(aa){L.bytes++;}}}if(L.opcode==="DS"||L.opcode==="RMB"){var Q=Parser.evaluate(L.params[0],R);if(L.params.length==2){var S=Parser.evaluate(L.params[1],R);
if(typeof S==="string"){S=S.charCodeAt(0);}L.bytes=Q;L.lens=[];for(var K=0;K<Q;K++){L.lens[K]=S;}}Z=Z+Q;continue;}if(L.opcode==="FILL"){var Q=Parser.evaluate(L.params[1],R);
var S=Parser.evaluate(L.params[0],R);if(typeof S==="string"){S=S.charCodeAt(0);}L.bytes=Q;L.lens=[];for(var K=0;K<Q;K++){L.lens[K]=S;}Z=Z+Q;continue;}if(L.opcode==="BSZ"||L.opcode==="ZMB"){var Q=Parser.evaluate(L.params[0],R);
L.bytes=Q;L.lens=[];for(var K=0;K<Q;K++){L.lens[K]=0;}Z=Z+Q;continue;}if(L.opcode==="DW"||L.opcode==="FDB"){L.bytes=0;for(T=0;T<L.params.length;T++){try{S=Parser.evaluate(L.params[T],R);
if(typeof(S)==="number"){L.bytes+=2;continue;}}catch(aa){L.bytes+=2;}}}var M=b.parseOpcode(I[X],R);if(M){L=M;}Z+=L.bytes;}return[I,R];};var t=function(I,H){var G=I.toString(16);
while(G.length<H){G="0"+G;}return G.toUpperCase();};var e=function(G){return t(G&255,2);};var c=function(G){return t(G,4);};var F=function(G){if(typeof(G)=="string"){return G.charCodeAt(0)&255;
}else{return G&255;}};var o=function(G){if(typeof(G)=="string"){return G.charCodeAt(0)&255;}else{return G&255;}};var j=function(R){var I=R[0];var Q=R[1];
var O=null,H=null,J,U,K;var G=[];for(var N=0,M=I.length;N<M;N++){try{O=I[N];O.pass=2;Q._PC=O.addr;if(O.opcode===".BLOCK"){G.push(O.numline);var S=Q["__"+G.join("/")];
for(var T=0;T<S.length;T++){Q[G.join("/")+"/"+S[T]]=Q[S[T]];Q[S[T]]=Q[G.join("/")+"/"+S[T]+"$"];}continue;}if(O.opcode===".ENDBLOCK"){var S=Q["__"+G.join("/")];
for(var T=0;T<S.length;T++){Q[S[T]]=Q[G.join("/")+"/"+S[T]];if(Q[S[T]]===undefined){delete (Q[S[T]]);}Q[G.join("/")+"/"+S[T]]=null;}G.pop();continue;}if(O.opcode===".ENT"){ASM.ENT=Parser.evaluate(O.params[0],Q);
continue;}if(O.opcode===".ENGINE"){ASM.ENGINE=O.params[0];continue;}if(O.opcode==="EQU"){Q[O.label]=Parser.evaluate(O.params[0],Q);continue;}if(O.opcode==="DB"||O.opcode==="FCB"){U=0;
O.lens=[];for(K=0;K<O.params.length;K++){J=Parser.evaluate(O.params[K],Q);if(typeof(J)==="number"){O.lens[U++]=Math.floor(J%256);continue;}if(typeof(J)==="string"){for(var L=0;
L<J.length;L++){O.lens[U++]=J.charCodeAt(L);}continue;}}continue;}if(O.opcode==="DW"||O.opcode==="FDB"){U=0;O.lens=[];for(K=0;K<O.params.length;K++){J=Parser.evaluate(O.params[K],Q);
if(typeof(J)==="number"){if(C){O.lens[U++]=Math.floor(J/256);O.lens[U++]=Math.floor(J%256);}else{O.lens[U++]=Math.floor(J%256);O.lens[U++]=Math.floor(J/256);
}continue;}}continue;}if(O.lens&&O.lens[1]&&typeof(O.lens[1])==="function"){if(O.lens[2]===null){H=O.lens[1](Q);if(typeof(H)=="string"){if(C){O.lens[1]=H.charCodeAt(0)&255;
O.lens[2]=H.charCodeAt(1)&255;}else{O.lens[2]=H.charCodeAt(0)&255;O.lens[1]=H.charCodeAt(1)&255;}}else{if(C){O.lens[2]=Math.floor(H%256);O.lens[1]=Math.floor(H/256);
}else{O.lens[1]=Math.floor(H%256);O.lens[2]=Math.floor(H/256);}}}else{H=O.lens[1](Q);O.lens[1]=F(H);}}if(O.lens&&O.lens.length>2&&typeof(O.lens[2])=="function"){H=O.lens[2](Q);
if(O.lens[3]===null){H=O.lens[2](Q);if(typeof(H)=="string"){if(C){O.lens[2]=H.charCodeAt(0)&255;O.lens[3]=H.charCodeAt(1)&255;}else{O.lens[3]=H.charCodeAt(0)&255;
O.lens[2]=H.charCodeAt(1)&255;}}else{if(C){O.lens[3]=H&255;O.lens[2]=H>>8;}else{O.lens[2]=H&255;O.lens[3]=H>>8;}}}else{O.lens[2]=F(H);}}if(O.lens&&O.lens.length>3&&typeof(O.lens[3])=="function"){H=O.lens[3](Q);
if(O.lens[4]===null){H=O.lens[3](Q);if(typeof(H)=="string"){if(C){O.lens[3]=H.charCodeAt(0)&255;O.lens[4]=H.charCodeAt(1)&255;}else{O.lens[4]=H.charCodeAt(0)&255;
O.lens[3]=H.charCodeAt(1)&255;}}else{if(C){O.lens[4]=H&255;O.lens[3]=H>>8;}else{O.lens[3]=H&255;O.lens[4]=H>>8;}}}else{O.lens[3]=F(H);}}if(O.lens&&O.lens.length>1){if(typeof(O.lens[1])=="string"){O.lens[1]=O.lens[1].charCodeAt(0);
}if(isNaN(O.lens[1])){throw {message:"param out of bounds, NaN"};}if(O.lens[1]>255||O.lens[1]<-128){throw {message:"param out of bounds - "+O.lens[1]};
}if(O.lens[1]<0){O.lens[1]=256+O.lens[1];}}}catch(P){throw {msg:P.message,s:O,e:P};}}return[I,Q];};var p=function(H,N,Q,P){var O;var M;var K="";if(P===undefined){P=false;
}for(var L=0,J=H.length;L<J;L++){M=H[L];O="";if(M.macro&&!Q){O+="        **MACRO UNROLL - "+M.macro+"\n";}if(M.addr!==undefined){O+=c(M.addr);if(M.phase){O+=" @"+c(M.addr-M.phase);
}O+=(P?" ":"   ");}if(M.lens){for(var G=0;G<M.lens.length;G++){O+=e(M.lens[G])+" ";}}if(!P){while(O.length<20){O+=" ";}}if(P){while(O.length<15){O+=" ";
}}if(M.label){O+=M.label+":   ";}if(!P){while(O.length<30){O+=" ";}}if(P){while(O.length<22){O+=" ";}}if(M.opcode){O+=M.opcode+(P?" ":"   ");}if(M.params){O+=M.params+(P?" ":"   ");
}if(M.remark){O+=";"+M.remark;}K+=O+"\n";}if(Q){return K;}K+="\n\n";for(var I in N){if(N[I]===null){continue;}if(I[0]=="_"&&I[1]=="_"){continue;}O="";O+=I;
while(O.length<12){O+=" ";}O+=c(N[I]);K+=O+"\n";}return K;};var h=function(G){var K;var M;var I=[];for(var J=0,H=G.length;J<H;J++){M=G[J];if(M.lens){for(var L=0;
L<M.lens.length;L++){I[M.addr+L]=J+1;}}}return I;};var B=function(L,H){var J=":";var G=H.length;var K=0;J+=e(G);J+=c(L);J+="00";K=G+Math.floor(L/256)+Math.floor(L%256);
for(var I=0;I<H.length;I++){J+=e(H[I]);K+=H[I];}J+=e(256-(K%256));return J;};var a=function(M,L){var G=0;var H=[];var K=16;var I="";for(var J=0;J<L.length;
J++){H.push(L[J]);if(++G===K){I+=B(M,H)+"\n";H=[];G=0;M+=K;}}if(H.length){I+=B(M,H)+"\n";}return I;};var E=function(I){var O;var M;var P=null;var N=0;var G=[];
var K="";for(var L=0,J=I.length;L<J;L++){M=I[L];var Q=M.addr;if(M.phase){Q-=M.phase;}if(Q!==undefined&&N===0){P=Q;}if(Q!=(P+N)){if(N){K+=a(P,G);}P=Q;N=0;
G=[];}if(M.lens){for(var H=0;H<M.lens.length;H++){G.push(M.lens[H]);}N+=M.lens.length;continue;}}if(G.length){K+=a(P,G);}K+=":00000001FF";return K;};var y=function(L,H){var J="S1";
var G=H.length;var K=0;J+=e(G+3);J+=c(L);K=G+3+Math.floor(L/256)+Math.floor(L%256);for(var I=0;I<H.length;I++){J+=e(H[I]);K+=H[I];}J+=e(256-(K%256));return J;
};var k=function(M,L){var G=0;var H=[];var K=16;var I="";for(var J=0;J<L.length;J++){H.push(L[J]);if(++G===K){I+=y(M,H)+"\n";H=[];G=0;M+=K;}}if(H.length){I+=y(M,H)+"\n";
}return I;};var i=function(I){var Q;var M;var R=null;var N=0;var G=[];var K="";for(var L=0,J=I.length;L<J;L++){M=I[L];var S=M.addr;if(M.phase){S-=M.phase;
}if(S!==undefined&&N===0){R=S;}if(S!=(R+N)){if(N){K+=k(R,G);}R=S;N=0;G=[];}if(M.lens){for(var H=0;H<M.lens.length;H++){G.push(M.lens[H]);}N+=M.lens.length;
continue;}}if(G.length){K+=k(R,G);}var P=ASM.ENT||0;var O=3+Math.floor(P/256)+Math.floor(P%256);K+="S903"+c(P)+e(255-(O%256));return K;};var D=function(G){var M=new Uint8Array(65536);
var L,K;for(var I=0,H=G.length;I<H;I++){L=G[I];K=L.addr;if(L.lens){for(var J=0;J<L.lens.length;J++){M[K++]=L.lens[J];}}}return M;};return{parse:w,pass1:l,pass2:j,parseLine:v,ENT:null,compile:function(K,I){try{ASM.ENT=null;
ASM.ENGINE=null;var G=ASM.parse(K,I);var H=ASM.pass1(G);H=ASM.pass2(H);return[null,H];}catch(J){return[J,null];}},compileAsync:function(L,J,G){try{var H=ASM.parse(L,J);
var I=ASM.pass1(H);I=ASM.pass2(I);G(null,I);}catch(K){G(K,null);}},lst:p,hex:E,srec:i,linemap:h,beautify:s,buff:D,fileGet:function(G){f=G;}};}));